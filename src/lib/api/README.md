# LibreFit API Layer

The API layer provides a type-safe interface between the Svelte frontend and the Tauri/Rust backend, with integrated error handling and toast notifications.

## Quick Start

```typescript
import { createCalorieTrackerEntry, CommonHooks } from '$lib/api';

// Automatic validation, error handling, and success toast
const entry = await createCalorieTrackerEntry(
  { newEntry: { added: '2024-01-01', amount: 500, category: 'l' } },
  CommonHooks.create('Entry')
);
```

## Directory Structure

```
src/lib/api/
â”œâ”€â”€ gen/                          # Auto-generated by tauri-typegen
â”‚   â”œâ”€â”€ commands.ts              # Tauri command functions
â”‚   â”œâ”€â”€ types.ts                 # Zod schemas + TypeScript types
â”‚   â””â”€â”€ index.ts                 # Re-exports
â”œâ”€â”€ command-hooks.ts             # Reusable hook utilities (NEW)
â”œâ”€â”€ category.ts                  # Food category helpers
â”œâ”€â”€ util.ts                      # API utility functions
â”œâ”€â”€ index.ts                     # Main export file
â”œâ”€â”€ MIGRATION_GUIDE.md          # How to migrate from old pattern
â”œâ”€â”€ EXAMPLE_USAGE.md            # Real-world examples
â””â”€â”€ README.md                    # This file
```

## Core Concepts

### 1. Generated Commands

All Tauri commands are auto-generated in `gen/commands.ts` with full type safety via Zod validation.

```typescript
import { createCalorieTrackerEntry } from '$lib/api';

// TypeScript knows the exact parameter shape
const entry = await createCalorieTrackerEntry({
  newEntry: { added: '2024-01-01', amount: 500, category: 'l' }
});
```

### 2. Command Hooks

Hooks provide optional callbacks for validation errors, invoke errors, success, and settlement:

```typescript
interface CommandHooks<T> {
  onValidationError?: (error: ZodError) => void;
  onInvokeError?: (error: unknown) => void;
  onSuccess?: (result: T) => void;
  onSettled?: () => void;
}
```

### 3. Pre-configured Hooks

Use `CommonHooks` for standard CRUD operations:

```typescript
import { CommonHooks } from '$lib/api';

// Create - shows "Entry created successfully"
await createCalorieTrackerEntry(params, CommonHooks.create('Entry'));

// Update - shows "Entry updated successfully"
await updateCalorieTrackerEntry(params, CommonHooks.update('Entry'));

// Delete - shows "Entry deleted successfully"
await deleteCalorieTrackerEntry(params, CommonHooks.delete('Entry'));

// Read - only shows errors, no success toast
await dailyDashboard(params, CommonHooks.read('Failed to load dashboard'));
```

### 4. Custom Hooks

Fine-tune notifications and behavior:

```typescript
import { createCommandHooks } from '$lib/api';

await wizardCreateTargets(
  params,
  createCommandHooks({
    successMessage: 'Setup complete! ğŸ‰',
    errorContext: 'Setup failed',
    successDuration: 5000,
    errorDuration: 8000
  })
);
```

### 5. Silent Hooks

For background operations without toast notifications:

```typescript
import { createSilentHooks } from '$lib/api';

// Only logs errors, no toasts
await dailyDashboard(params, createSilentHooks('Background refresh failed'));
```

## Available Commands

### Calorie Tracking
- `createCalorieTrackerEntry(params, hooks?)` - Create new entry
- `updateCalorieTrackerEntry(params, hooks?)` - Update existing entry
- `deleteCalorieTrackerEntry(params, hooks?)` - Delete entry
- `getCalorieTrackerForDateRange(params, hooks?)` - Fetch entries for date range

### Weight Tracking
- `createWeightTrackerEntry(params, hooks?)` - Record weight
- `updateWeightTrackerEntry(params, hooks?)` - Update weight entry
- `deleteWeightTrackerEntry(params, hooks?)` - Delete weight entry
- `getWeightTrackerForDateRange(params, hooks?)` - Fetch weight history

### Targets
- `createCalorieTarget(params, hooks?)` - Set calorie goal
- `createWeightTarget(params, hooks?)` - Set weight goal
- `updateWeightTarget(params, hooks?)` - Update weight goal
- `deleteWeightTarget(params, hooks?)` - Delete weight goal

### Dashboard & History
- `dailyDashboard(params, hooks?)` - Get today's summary
- `getTrackerHistory(params, hooks?)` - Get historical data
- `getTrackerProgress(params, hooks?)` - Get progress metrics

### User & Profile
- `getUser(params?, hooks?)` - Get user profile
- `updateUser(params, hooks?)` - Update profile
- `getBodyData(params?, hooks?)` - Get body measurements
- `updateBodyData(params, hooks?)` - Update body measurements

### Wizard
- `wizardCreateTargets(params, hooks?)` - Complete setup wizard
- `wizardCalculateTdee(params, hooks?)` - Calculate TDEE
- `wizardCalculateForTargetDate(params, hooks?)` - Calculate for target date
- `wizardCalculateForTargetWeight(params, hooks?)` - Calculate for target weight

### Categories
- `getFoodCategories(params?, hooks?)` - Get all food categories
- `getFoodCategory(params, hooks?)` - Get specific category

## Usage Patterns

### Basic CRUD

```typescript
import { createCalorieTrackerEntry, CommonHooks } from '$lib/api';

// Create
const entry = await createCalorieTrackerEntry(
  { newEntry },
  CommonHooks.create('Entry')
);

// Update
const updated = await updateCalorieTrackerEntry(
  { updatedEntry },
  CommonHooks.update('Entry')
);

// Delete
await deleteCalorieTrackerEntry(
  { trackerId: id },
  CommonHooks.delete('Entry')
);
```

### Custom Success Handler

```typescript
import { updateUser, createCommandHooks } from '$lib/api';

const baseHooks = createCommandHooks({
  successMessage: 'Profile updated!',
  errorContext: 'Failed to update profile'
});

await updateUser(params, {
  ...baseHooks,
  onSuccess: (user) => {
    baseHooks.onSuccess?.(user);
    goto('/profile');
  }
});
```

### Error Handling

```typescript
import { createCalorieTrackerEntry, CommonHooks } from '$lib/api';

try {
  const entry = await createCalorieTrackerEntry(
    { newEntry },
    CommonHooks.create('Entry')
  );
  // Success - toast already shown
  entries = [...entries, entry];
} catch (error) {
  // Error - toast already shown
  // Optional: additional error handling
}
```

## Migration from Old Pattern

If you're migrating from the old `validated-commands.ts` pattern, see [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md).

**Key changes:**
- âŒ Old: `ValidatedResult<T>` with manual success checks
- âœ… New: Direct `T` return with automatic error handling via hooks

**Before:**
```typescript
const result = await api.createCalorieTrackerEntry(params);
if (result.success) {
  toast.success('Created');
} else {
  toast.error(result.error.message);
}
```

**After:**
```typescript
await createCalorieTrackerEntry(params, CommonHooks.create('Entry'));
// Toasts handled automatically
```

## Examples

See [EXAMPLE_USAGE.md](./EXAMPLE_USAGE.md) for comprehensive real-world examples including:
- Basic CRUD operations
- Custom success messages
- Silent background operations
- Error handling with retry logic
- Optimistic UI updates
- Form integration
- Batch operations

## Type Safety

All commands are fully typed:

```typescript
import type {
  CalorieTracker,
  NewCalorieTracker,
  WeightTracker,
  NewWeightTracker,
  DailyDashboard,
  TrackerHistory,
  LibreUser,
  BodyData
} from '$lib/api';
```

## Best Practices

1. **Use CommonHooks for standard operations** - Covers most use cases
2. **Use createSilentHooks for background tasks** - Prevents notification spam
3. **Customize hooks for important operations** - Wizard completion, critical updates
4. **Don't show success toasts for reads** - Use `CommonHooks.read()` or `createSilentHooks()`
5. **Extend hooks for custom behavior** - Combine toast notifications with navigation/state updates
6. **Handle field-level validation** - Set `showValidationErrors: false` and extract from `ZodError`

## Development

### Regenerating Types

When Rust commands change, regenerate TypeScript types:

```bash
cd src-tauri
cargo build
```

This will automatically update `src/lib/api/gen/*` via `tauri-typegen`.

### Testing

```typescript
import { describe, it, expect, vi } from 'vitest';
import { createCommandHooks } from '$lib/api/command-hooks';

describe('Command Hooks', () => {
  it('shows success toast', () => {
    const hooks = createCommandHooks({ successMessage: 'Success!' });
    hooks.onSuccess?.('result');
    // Assert toast.success was called
  });
});
```

## Troubleshooting

### "Command not found" error
- Ensure you've run `cargo build` to regenerate types
- Check that the Rust command exists in `src-tauri/src/commands/`

### Types out of sync
- Delete `src/lib/api/gen/*` and rebuild
- Ensure `tauri-typegen` is up to date in `Cargo.toml`

### Toasts not showing
- Verify `ToastContainer` is in your root layout
- Check that veilchen's toast store is properly imported

## Links

- [Tauri Typegen Documentation](https://github.com/thwbh/tauri-typegen)
- [Veilchen Toast Store](https://github.com/thwbh/veilchen)
- [Zod Validation](https://zod.dev/)
