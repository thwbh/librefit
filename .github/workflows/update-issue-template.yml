name: Update Issue Template with Latest Release

on:
  release:
    types: [published]
  workflow_dispatch: # Allow manual trigger

jobs:
  update-bug-template:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for tags

      - name: Get latest release tag
        id: get-tag
        run: |
          # Get all tags sorted by version
          LATEST_TAG=$(git tag --sort=-v:refname | head -n 1)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Update bug report template
        run: |
          LATEST_TAG="${{ steps.get-tag.outputs.latest_tag }}"
          TEMPLATE_FILE=".github/ISSUE_TEMPLATE/bug_report.yml"

          # Check if tag already exists in template
          if grep -q "        - $LATEST_TAG" "$TEMPLATE_FILE"; then
            echo "Tag $LATEST_TAG already exists in template"
            exit 0
          fi

          # Add new tag after "latest" line, maintaining proper indentation
          sed -i "/        - latest/a\\        - $LATEST_TAG" "$TEMPLATE_FILE"

          echo "Added $LATEST_TAG to bug report template"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: add ${{ steps.get-tag.outputs.latest_tag }} to bug report template"
          title: "chore: Update bug report template with ${{ steps.get-tag.outputs.latest_tag }}"
          body: |
            This PR automatically adds the latest release tag to the bug report issue template.

            **Release**: ${{ steps.get-tag.outputs.latest_tag }}

            This ensures users can select the latest version when reporting bugs.
          branch: update-issue-template-${{ steps.get-tag.outputs.latest_tag }}
          delete-branch: true
          labels: |
            automated
            documentation
