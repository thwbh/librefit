name: 'Release'

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  generate-version:
    name: 'Generate CalVer Version'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      semver: ${{ steps.version.outputs.SEMVER }}
      tag: ${{ steps.version.outputs.TAG }}
      version_code: ${{ steps.version.outputs.VERSION_CODE }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: 'Generate version number'
        id: version
        run: |
          chmod +x .github/scripts/generate-version.sh
          .github/scripts/generate-version.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Display version info'
        run: |
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          echo "Semver: ${{ steps.version.outputs.SEMVER }}"
          echo "Tag: ${{ steps.version.outputs.TAG }}"
          echo "Version Code: ${{ steps.version.outputs.VERSION_CODE }}"

  update-version-files:
    name: 'Update Version in Files'
    needs: generate-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 'Update package.json'
        run: |
          sed -i 's/"version": ".*"/"version": "${{ needs.generate-version.outputs.semver }}"/' package.json
          cat package.json | grep version

      - name: 'Update Cargo.toml'
        run: |
          # Only update the version in the [package] section, not dependencies
          sed -i '/^\[package\]/,/^\[/ s/^version = ".*"/version = "${{ needs.generate-version.outputs.semver }}"/' src-tauri/Cargo.toml
          echo "Updated package version:"
          sed -n '/^\[package\]/,/^\[/p' src-tauri/Cargo.toml | grep version

      - name: 'Update tauri.conf.json'
        run: |
          sed -i 's/"version": ".*"/"version": "${{ needs.generate-version.outputs.semver }}"/' src-tauri/tauri.conf.json
          cat src-tauri/tauri.conf.json | grep version

      - name: 'Upload updated files'
        uses: actions/upload-artifact@v4
        with:
          name: version-files
          path: |
            package.json
            src-tauri/Cargo.toml
            src-tauri/tauri.conf.json

  create-release:
    name: 'Create GitHub Release and Commit Version Updates'
    needs: [generate-version, update-version-files]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 'Download version files'
        uses: actions/download-artifact@v4
        with:
          name: version-files

      - name: 'Commit version bump'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json src-tauri/Cargo.toml src-tauri/tauri.conf.json
          git commit -m "chore: bump version to ${{ needs.generate-version.outputs.version }} [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: 'Create Git tag'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.generate-version.outputs.tag }}" -m "Release ${{ needs.generate-version.outputs.version }}"
          git push origin "${{ needs.generate-version.outputs.tag }}"

      - name: 'Create GitHub Release'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.generate-version.outputs.tag }}
          name: '${{ needs.generate-version.outputs.version }}'
          body: |
            ðŸŽ‰ LibreFit v${{ needs.generate-version.outputs.version }}

            ## What's Changed
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ## Installation

            ### F-Droid
            LibreFit will be available on F-Droid soon. F-Droid builds directly from source.

            ### Google Play
            Use the manual release workflow to build and publish to Google Play.

            ### Direct APK
            Manual builds can be created using the Android Release workflow.

            ---
            ðŸ“… Released on ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
