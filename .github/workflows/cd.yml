name: 'Release'

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  generate-version:
    name: 'Generate CalVer Version'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      tag: ${{ steps.version.outputs.TAG }}
      version_code: ${{ steps.version.outputs.VERSION_CODE }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: 'Generate version number'
        id: version
        run: |
          chmod +x .github/scripts/generate-version.sh
          .github/scripts/generate-version.sh

      - name: 'Display version info'
        run: |
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          echo "Tag: ${{ steps.version.outputs.TAG }}"
          echo "Version Code: ${{ steps.version.outputs.VERSION_CODE }}"

  update-version-files:
    name: 'Update Version in Files'
    needs: generate-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 'Update package.json'
        run: |
          sed -i 's/"version": ".*"/"version": "${{ needs.generate-version.outputs.version }}"/' package.json
          cat package.json | grep version

      - name: 'Update Cargo.toml'
        run: |
          sed -i 's/^version = ".*"/version = "${{ needs.generate-version.outputs.version }}"/' src-tauri/Cargo.toml
          cat src-tauri/Cargo.toml | grep version

      - name: 'Update tauri.conf.json'
        run: |
          sed -i 's/"version": ".*"/"version": "${{ needs.generate-version.outputs.version }}"/' src-tauri/tauri.conf.json
          cat src-tauri/tauri.conf.json | grep version

      - name: 'Update Android versionCode and versionName'
        run: |
          mkdir -p src-tauri/gen/android/app
          cat > src-tauri/gen/android/app/tauri.properties << EOF
          tauri.android.versionCode=${{ needs.generate-version.outputs.version_code }}
          tauri.android.versionName=${{ needs.generate-version.outputs.version }}
          EOF
          cat src-tauri/gen/android/app/tauri.properties

      - name: 'Upload updated files'
        uses: actions/upload-artifact@v4
        with:
          name: version-files
          path: |
            package.json
            src-tauri/Cargo.toml
            src-tauri/tauri.conf.json
            src-tauri/gen/android/app/tauri.properties

  build-android:
    name: 'Build Android APK'
    needs: [generate-version, update-version-files]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 'Download version files'
        uses: actions/download-artifact@v4
        with:
          name: version-files

      - name: 'Restore version files to correct locations'
        run: |
          mv package.json package.json.versioned
          mv src-tauri/Cargo.toml src-tauri/Cargo.toml.versioned
          mv src-tauri/tauri.conf.json src-tauri/tauri.conf.json.versioned
          cp package.json.versioned package.json
          cp src-tauri/Cargo.toml.versioned src-tauri/Cargo.toml
          cp src-tauri/tauri.conf.json.versioned src-tauri/tauri.conf.json
          mkdir -p src-tauri/gen/android/app
          mv src-tauri/gen/android/app/tauri.properties src-tauri/gen/android/app/tauri.properties || true

      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 'Install frontend dependencies'
        run: npm ci

      - name: 'Setup Java'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 'Setup Rust'
        uses: dtolnay/rust-toolchain@stable

      - name: 'Rust cache'
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: 'Install Android targets'
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ needs.generate-version.outputs.tag }}
          releaseName: 'LibreFit v${{ needs.generate-version.outputs.version }}'
          releaseBody: |
            ðŸŽ‰ LibreFit v${{ needs.generate-version.outputs.version }}

            ## What's Changed
            See the full changelog at https://github.com/${{ github.repository }}/compare/${{ needs.generate-version.outputs.tag }}

            ## Installation
            Download the APK below and install on your Android device.

            ---
            ðŸ¤– Generated with CalVer (YY.WW.MICRO format)
            ðŸ“… Released on ${{ github.event.head_commit.timestamp }}
          releaseDraft: false
          prerelease: false
          includeDebug: false
          includeRelease: true
          includeUpdaterJson: false
          args: --target aarch64-linux-android --apk

  create-release-commit:
    name: 'Commit Version Updates'
    needs: [generate-version, build-android]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Download version files'
        uses: actions/download-artifact@v4
        with:
          name: version-files

      - name: 'Move files to correct locations'
        run: |
          mv package.json.versioned package.json || cp package.json package.json
          mv src-tauri/Cargo.toml.versioned src-tauri/Cargo.toml || cp src-tauri/Cargo.toml src-tauri/Cargo.toml
          mv src-tauri/tauri.conf.json.versioned src-tauri/tauri.conf.json || cp src-tauri/tauri.conf.json src-tauri/tauri.conf.json
          mkdir -p src-tauri/gen/android/app
          cp src-tauri/gen/android/app/tauri.properties src-tauri/gen/android/app/tauri.properties || true

      - name: 'Commit version bump'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json src-tauri/Cargo.toml src-tauri/tauri.conf.json
          git add src-tauri/gen/android/app/tauri.properties || true
          git commit -m "chore: bump version to ${{ needs.generate-version.outputs.version }} [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"
