name: 'Android Release'

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - apk
          - aab
          - both
        default: 'both'

permissions:
  contents: write

jobs:
  build-android:
    name: 'Build Android App'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0" --locked

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > /tmp/upload-keystore.jks

      - name: Initialize Tauri Android
        working-directory: src-tauri
        run: cargo tauri android init

      - name: Apply Android templates and configuration
        working-directory: src-tauri
        env:
          KEYSTORE_FILE: /tmp/upload-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x ./android-templates/setup-android.sh
          ./android-templates/setup-android.sh

      - name: Build APK
        if: inputs.release_type == 'apk' || inputs.release_type == 'both'
        working-directory: src-tauri
        run: cargo tauri android build --apk true

      - name: Build AAB
        if: inputs.release_type == 'aab' || inputs.release_type == 'both'
        working-directory: src-tauri
        run: cargo tauri android build --aab true

      - name: Upload APK artifact
        if: inputs.release_type == 'apk' || inputs.release_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: librefit-android-apk
          path: src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
          if-no-files-found: error

      - name: Upload AAB artifact
        if: inputs.release_type == 'aab' || inputs.release_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: librefit-android-aab
          path: src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab
          if-no-files-found: error

      - name: Determine release strategy
        id: release_strategy
        run: |
          REF="${{ github.ref }}"
          REF_NAME="${{ github.ref_name }}"

          # Check if ref is a tag (CalVer format: YY.WW.MICRO)
          if [[ "$REF" == refs/tags/* ]] && [[ "$REF_NAME" =~ ^[0-9]{2}\.[0-9]{1,2}\.[0-9]+$ ]]; then
            echo "strategy=existing_tag" >> $GITHUB_OUTPUT
            echo "tag=$REF_NAME" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "Attaching to existing CalVer tag: $REF_NAME"
          # Check if branch is main
          elif [[ "$REF_NAME" == "main" ]]; then
            echo "strategy=latest_release" >> $GITHUB_OUTPUT
            # Get the latest release tag
            LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
            if [ -z "$LATEST_TAG" ]; then
              echo "Error: No releases found to attach to"
              exit 1
            fi
            echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "Attaching to latest release: $LATEST_TAG"
          # Any other branch - create draft release
          else
            DRAFT_TAG="draft-$REF_NAME-${{ github.run_number }}"
            echo "strategy=draft" >> $GITHUB_OUTPUT
            echo "tag=$DRAFT_TAG" >> $GITHUB_OUTPUT
            echo "draft=true" >> $GITHUB_OUTPUT
            echo "Creating draft release: $DRAFT_TAG"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts to release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_strategy.outputs.tag }}
          name: ${{ steps.release_strategy.outputs.strategy == 'draft' && format('Draft - {0}', github.ref_name) || '' }}
          draft: ${{ steps.release_strategy.outputs.draft }}
          files: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
            src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
