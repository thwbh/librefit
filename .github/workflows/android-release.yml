name: 'Android Release'

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android:
    name: 'Build Android App'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          cache-all-crates: true
          shared-key: android-build
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29
          local-cache: true

      - name: Cache Gradle dependencies and build
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Cache Tauri CLI tools
        id: cache-tauri-cli
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-tauri
            ~/.cargo/bin/tauri-typegen
          key: ${{ runner.os }}-tauri-cli-2.9.5-typegen-0.3.2

      - name: Install Tauri CLI and typegen
        run: |
          if ! command -v cargo-tauri &> /dev/null; then
            cargo install tauri-cli --version "=2.9.5" --locked
          fi
          if ! command -v tauri-typegen &> /dev/null; then
            cargo install tauri-typegen --version "=0.3.2" --locked
          fi

      - name: Determine release strategy
        id: release_strategy
        run: |
          REF="${{ github.ref }}"
          REF_NAME="${{ github.ref_name }}"

          # Check if ref is a tag (CalVer format: YY.WW.MICRO)
          if [[ "$REF" == refs/tags/* ]] && [[ "$REF_NAME" =~ ^[0-9]{2}\.[0-9]{1,2}(\.[0-9]+)?$ ]]; then
            echo "strategy=existing_tag" >> $GITHUB_OUTPUT
            echo "tag=$REF_NAME" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "Attaching to existing CalVer tag: $REF_NAME"
          # Check if branch is main
          elif [[ "$REF_NAME" == "main" ]]; then
            echo "strategy=latest_release" >> $GITHUB_OUTPUT
            # Get the latest release tag
            LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
            if [ -z "$LATEST_TAG" ]; then
              echo "Error: No releases found to attach to"
              exit 1
            fi
            echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "Attaching to latest release: $LATEST_TAG"
          # Any other branch - create draft release
          else
            DRAFT_TAG="draft-$REF_NAME-${{ github.run_number }}"
            echo "strategy=draft" >> $GITHUB_OUTPUT
            echo "tag=$DRAFT_TAG" >> $GITHUB_OUTPUT
            echo "draft=true" >> $GITHUB_OUTPUT
            echo "Creating draft release: $DRAFT_TAG"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > /tmp/upload-keystore.jks

      - name: Initialize Tauri Android
        working-directory: src-tauri
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: cargo tauri android init

      - name: Generate Android icons
        working-directory: src-tauri
        run: cargo tauri icon icons/icon.png

      - name: Apply Android templates and configuration
        working-directory: src-tauri
        env:
          KEYSTORE_FILE: /tmp/upload-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          NDK_PATH: ${{ steps.setup-ndk.outputs.ndk-path }}
          NDK_VERSION: ${{ steps.setup-ndk.outputs.ndk-full-version }}
        run: |
          chmod +x ./android-templates/setup-android.sh
          ./android-templates/setup-android.sh

      - name: Build Universal APK
        working-directory: src-tauri
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: cargo tauri android build --apk true

      - name: Rename APK with version
        run: |
          VERSION="${{ steps.release_strategy.outputs.tag }}"
          APK_DIR="src-tauri/gen/android/app/build/outputs/apk/universal/release"

          # Find the generated APK
          ORIGINAL_APK=$(find "$APK_DIR" -name "*.apk" -type f | head -1)

          if [ -n "$ORIGINAL_APK" ]; then
            # Rename to librefit-{version}.apk
            mv "$ORIGINAL_APK" "$APK_DIR/librefit-${VERSION}.apk"
            echo "Renamed APK to: librefit-${VERSION}.apk"
            ls -lh "$APK_DIR/"
          else
            echo "Error: No APK found in $APK_DIR"
            exit 1
          fi

      - name: Upload artifacts to release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_strategy.outputs.tag }}
          name: ${{ steps.release_strategy.outputs.strategy == 'draft' && format('Draft - {0}', github.ref_name) || '' }}
          draft: ${{ steps.release_strategy.outputs.draft }}
          files: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
            src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
