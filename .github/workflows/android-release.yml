name: 'Android Release'

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - apk
          - aab
          - both
        default: 'both'

permissions:
  contents: write

jobs:
  build-android:
    name: 'Build Android App'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0" --locked

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > /tmp/upload-keystore.jks

      - name: Initialize Tauri Android
        working-directory: src-tauri
        run: cargo tauri android init

      - name: Apply Android templates and configuration
        working-directory: src-tauri
        env:
          KEYSTORE_FILE: /tmp/upload-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x ./android-templates/setup-android.sh
          ./android-templates/setup-android.sh

      - name: Build APK
        if: inputs.release_type == 'apk' || inputs.release_type == 'both'
        working-directory: src-tauri
        run: cargo tauri android build --apk

      - name: Build AAB
        if: inputs.release_type == 'aab' || inputs.release_type == 'both'
        working-directory: src-tauri
        run: cargo tauri android build --aab

      - name: Upload APK artifact
        if: inputs.release_type == 'apk' || inputs.release_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: librefit-android-apk
          path: src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
          if-no-files-found: error

      - name: Upload AAB artifact
        if: inputs.release_type == 'aab' || inputs.release_type == 'both'
        uses: actions/upload-artifact@v4
        with:
          name: librefit-android-aab
          path: src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab
          if-no-files-found: error

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          draft: true
          files: |
            src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk
            src-tauri/gen/android/app/build/outputs/bundle/universalRelease/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
